name: Dragon Between Deployment

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  test:
    name: Run tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18.x]
    steps:
      - name: Check out repo
        uses: actions/checkout@v3
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}
      - name: Install dependencies
        run: npm ci
      - name: Run linter
        run: npm run lint
      - name: Run tests
        run: npm test
  deploy:
    name: Deploy to dragonbetween.net
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Establish SSH connection
        uses: webfactory/ssh-agent@v0.5.4
        with:
          ssh-private-key: ${{ secrets.DRAGONBETWEEN_SSH_KEY }}
      - name: Add to known hosts
        run: ssh-keyscan -H ${{ secrets.DRAGONBETWEEN_SSH_HOST }} >> ~/.ssh/known_hosts
      - name: Pull latest from Github
        run: ssh ${{ secrets.DRAGONBETWEEN_SSH_USER }}@${{ secrets.DRAGONBETWEEN_SSH_HOST }} "cd dragonbetween && git pull"
      - name: Install dependencies
        run: ssh ${{ secrets.DRAGONBETWEEN_SSH_USER }}@${{ secrets.DRAGONBETWEEN_SSH_HOST }} "cd dragonbetween && npm install"
      - name: Run compilers
        run: ssh ${{ secrets.DRAGONBETWEEN_SSH_USER }}@${{ secrets.DRAGONBETWEEN_SSH_HOST }} "cd dragonbetween && npm run compile"
      - name: Make a new build
        run: ssh ${{ secrets.DRAGONBETWEEN_SSH_USER }}@${{ secrets.DRAGONBETWEEN_SSH_HOST }} "cd dragonbetween && npm run build"
      - name: Restart app
        run: ssh ${{ secrets.DRAGONBETWEEN_SSH_USER }}@${{ secrets.DRAGONBETWEEN_SSH_HOST }} "pm2 restart dragonbetween"